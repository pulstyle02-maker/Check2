<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Final Boss Checkout - Mind Your Minors</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Custom CSS for Sleek Design & Animations */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f8fafc; /* Very light slate background */
  }
  .card-container {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }
  .input-field {
    @apply w-full p-3 bg-white border border-gray-200 rounded-xl transition duration-200 ease-in-out focus:ring-4 focus:ring-cyan-500/30 focus:border-cyan-500 shadow-inner;
  }
  /* Progress Bar Styles */
  .progress-step {
    @apply flex items-center mb-6 transition-all duration-300 ease-in-out cursor-pointer;
  }
  .step-circle {
    @apply w-10 h-10 flex items-center justify-center rounded-full text-white font-bold text-lg mr-4 flex-shrink-0 transition-all duration-300;
  }
  .step-circle-active {
    @apply bg-cyan-600 shadow-xl shadow-cyan-500/50 scale-105;
  }
  .step-circle-inactive {
    @apply bg-gray-200 text-gray-500;
  }
  .step-circle-complete {
    @apply bg-green-500 shadow-lg shadow-green-500/50;
  }

  /* Animations for step transition */
  .step-section {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.4s ease-out, transform 0.4s ease-out;
  }
  .step-active {
    opacity: 1;
    transform: translateY(0);
  }
  .thankyou-card {
    opacity: 0;
    transform: scale(0.9);
    transition: opacity 0.5s ease-out 0.2s, transform 0.5s ease-out 0.2s;
  }
  .thankyou-active {
    opacity: 1;
    transform: scale(1);
  }
</style>
</head>
<body>
<div id="app" class="min-h-screen p-4 md:p-10">
  <div class="max-w-7xl mx-auto">
    <header class="mb-10 text-center">
      <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Mind Your Minors <span class="text-cyan-600">Checkout</span></h1>
      <p class="text-gray-500 mt-2 text-lg">Block 6 Book | Base Price: <span id="base-price-display">â‚¨500.00</span></p>
    </header>

    <div class="md:grid md:grid-cols-3 md:gap-12">

      <!-- Left Column: Progress Sidebar (Desktop) -->
      <div id="progress-bar-desktop" class="md:col-span-1 hidden md:block">
        <div class="sticky top-10 p-6 bg-white rounded-2xl card-container">
          <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Order Process</h2>
          <div id="step-container">
            <!-- Steps are rendered here by JS -->
          </div>
        </div>
      </div>

      <!-- Right Column: Form and Order Summary -->
      <div class="md:col-span-2 space-y-8">

        <!-- Mobile Progress Bar (Visible only on small screens) -->
        <div id="progress-bar-mobile" class="md:hidden p-4 bg-white rounded-xl card-container mb-6">
          <h3 class="font-bold text-lg text-gray-800 mb-3">Step <span id="mobile-step-num">1</span> of 3: <span id="mobile-step-name">Details & Discount</span></h3>
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div id="mobile-progress-fill" class="bg-cyan-600 h-2.5 rounded-full transition-all duration-500" style="width: 33%;"></div>
          </div>
        </div>
        
        <!-- Order Summary Card (Sticky for desktop, visible on top for mobile) -->
        <div class="md:hidden sticky top-4 p-6 bg-white rounded-2xl card-container border border-cyan-100">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Order Summary</h3>
          <div class="space-y-3 text-lg">
            <div class="flex justify-between text-gray-600 border-b border-dashed pb-2">
              <span>Book Price</span>
              <span>â‚¨500.00</span>
            </div>
            <div class="flex justify-between text-red-500 font-medium">
              <span>Discount (<span id="summaryCouponDisplay">None</span>)</span>
              <span id="summaryDiscount">-â‚¨0.00</span>
            </div>
            <div class="flex justify-between pt-3 border-t-2 border-cyan-500 font-bold text-2xl">
              <span>TOTAL DUE</span>
              <span id="summaryTotal">â‚¨500.00</span>
            </div>
          </div>
        </div>

        <!-- Checkout Form - The Main Event -->
        <form id="checkout-form" class="space-y-8">
          <!-- Hidden fields for FormSubmit -->
          <input type="hidden" name="_captcha" value="false">
          <input type="hidden" name="Book Name" value="Mind Your Minors - Block 6 Book">
          <input type="hidden" name="Base Price" value="500">
          <input type="hidden" name="Order Number" id="hiddenOrderNumber">
          <input type="hidden" name="Total Amount Paid" id="hiddenTotalAmount">
          <input type="hidden" name="Coupon Used" id="hiddenCouponUsed">
          <input type="hidden" name="_subject" id="formSubmitSubject">

          <!-- Step 1: Details -->
          <section id="shipping-step" data-step-name="Details & Discount" class="step-section card-container p-6 md:p-10 bg-white rounded-2xl border border-cyan-100 step-active">
            <h2 class="text-3xl font-bold text-cyan-700 mb-6">1. Student Details & Shipping</h2>
            <div class="space-y-5">
              
              <!-- Name & Contact -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" name="First Name" id="firstName" placeholder="First Name" required class="input-field">
                <input type="text" name="Last Name" id="lastName" placeholder="Last Name" required class="input-field">
              </div>
              <input type="tel" name="Contact Number" id="contactNumber" placeholder="Contact Number (e.g., 03XX-XXXXXXX)" required class="input-field">
              
              <!-- College Select & AIMC/Coupon -->
              <div>
                <label for="collegeSelect" class="block text-sm font-medium text-gray-600 mb-2">Select College</label>
                <input list="collegesList" name="College" id="collegeSelect" class="input-field" placeholder="Search or select your college..." required>
                <datalist id="collegesList">
                  <!-- Example colleges for datalist -->
                  <option value="Allama Iqbal Medical College">
                  <option value="King Edward Medical University">
                  <option value="Fatima Jinnah Medical College">
                  <option value="Services Institute of Medical Sciences">
                </datalist>
              </div>

              <!-- AIMC Discount Block (Conditional) -->
              <div id="aimc-fields" class="space-y-4 p-5 bg-yellow-50 border border-yellow-300 rounded-xl hidden transition-all duration-300">
                <p class="text-lg font-bold text-yellow-800">AIMC Exclusive Discount Available!</p>
                <input type="text" name="AIMC Roll Number" id="rollNumber" placeholder="AIMC Roll Number (Required for discount)" class="input-field bg-white">
                <div class="flex items-center space-x-3">
                  <input type="text" name="Coupon Code Entered" id="couponCode" placeholder="Enter Coupon Code (AIMC20)" class="input-field flex-grow uppercase font-mono">
                  <button type="button" id="applyCouponBtn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-cyan-700 transition duration-150 shadow-md flex-shrink-0">Apply</button>
                  <div id="couponStatus" class="w-10 h-10 flex items-center justify-center text-xl font-bold"></div>
                </div>
              </div>

              <!-- Shipping Address -->
              <h3 class="font-bold text-gray-900 pt-4 border-t mt-6">Shipping Address</h3>
              <input type="text" name="Street Address" id="streetAddress" placeholder="Street Address / House No." required class="input-field">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" name="City" id="city" placeholder="City" required class="input-field">
                <input type="text" name="Province" id="province" placeholder="Province / State" required class="input-field">
                <input type="text" name="Zip Code" id="zipCode" placeholder="Zip Code" required class="input-field">
              </div>
            </div>
            <!-- Step Navigation -->
            <div class="flex justify-end mt-8">
              <button type="button" data-step-action="next" class="bg-gray-800 text-white font-bold py-4 px-8 rounded-xl hover:bg-cyan-700 transition duration-200 shadow-lg">
                Continue to Payment &rarr;
              </button>
            </div>
          </section>

          <!-- Step 2: Payment -->
          <section id="payment-step" data-step-name="Payment & Receipt" class="step-section card-container p-6 md:p-10 bg-white rounded-2xl border border-cyan-100 hidden">
            <h2 class="text-3xl font-bold text-cyan-700 mb-6">2. Secure Payment</h2>
            <div class="space-y-6">
              <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                <h3 class="font-extrabold text-xl text-blue-800 mb-3">Required Transfer Amount</h3>
                <p class="text-4xl font-mono font-bold text-cyan-600" id="amountPaidDisplay">â‚¨500.00</p>
              </div>
              
              <p class="text-gray-700">Please complete the transfer to the following **Nayapay** account:</p>
              
              <div class="space-y-2 p-5 bg-gray-50 rounded-lg border border-gray-200 text-lg">
                <div class="flex justify-between"><span class="font-medium text-gray-600">Account Name:</span> <span class="font-semibold text-gray-900">Mind Your Minors</span></div>
                <div class="flex justify-between"><span class="font-medium text-gray-600">Account Number:</span> <span class="font-semibold text-gray-900">0123456789</span></div>
                <div class="flex justify-between"><span class="font-medium text-gray-600">Bank/Service:</span> <span class="font-semibold text-gray-900">Nayapay</span></div>
              </div>

              <div class="pt-4">
                <label for="paymentSlip" class="block mb-2 font-bold text-gray-700">Upload Payment Slip (Receipt/Proof)</label>
                <input type="file" name="Payment Slip" id="paymentSlip" accept="image/png, image/jpeg, application/pdf" required class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                <p class="text-sm text-gray-500 mt-1">Accepted formats: JPG, PNG, PDF (Max size 5MB).</p>
              </div>
            </div>
            <!-- Step Navigation -->
            <div class="flex justify-between mt-8">
              <button type="button" data-step-action="prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-300 transition duration-200">
                &larr; Back to Details
              </button>
              <button type="button" data-step-action="next" class="bg-cyan-600 text-white font-bold py-4 px-8 rounded-xl hover:bg-cyan-700 transition duration-200 shadow-lg shadow-cyan-500/50">
                Review Order &rarr;
              </button>
            </div>
          </section>

          <!-- Step 3: Confirm -->
          <section id="review-step" data-step-name="Confirm Order" class="step-section card-container p-6 md:p-10 bg-white rounded-2xl border border-cyan-100 hidden">
            <h2 class="text-3xl font-bold text-cyan-700 mb-6">3. Final Review & Confirmation</h2>
            <div class="space-y-6">
              <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                <h3 class="font-bold text-xl text-gray-900 mb-3 border-b pb-2">Your Order Details</h3>
                <div class="space-y-2">
                  <p><span class="font-semibold">Book:</span> Mind Your Minors - Block 6</p>
                  <p><span class="font-semibold">Original Price:</span> â‚¨500.00</p>
                  <p><span class="font-semibold">Coupon Used:</span> <span id="reviewCoupon" class="text-red-500 font-bold">None</span></p>
                  <p class="text-2xl font-extrabold text-cyan-600 pt-3 border-t">Total Payable: <span id="reviewTotal">â‚¨500.00</span></p>
                  <p class="text-sm text-gray-500 pt-2"><span class="font-mono" id="reviewOrderNumber"># Will be generated upon confirmation</span></p>
                </div>
              </div>

              <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                <h3 class="font-bold text-xl text-gray-900 mb-3 border-b pb-2">Shipping Information</h3>
                <p id="reviewShippingDetails" class="whitespace-pre-wrap"></p>
                <p class="mt-2"><span class="font-semibold">Contact:</span> <span id="reviewContact"></span></p>
              </div>
              
              <div id="submit-message" class="text-center font-medium text-lg text-red-500 hidden">Please fill all required fields before confirming.</div>

            </div>
            <!-- Step Navigation -->
            <div class="flex justify-between mt-8">
              <button type="button" data-step-action="prev" class="bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-300 transition duration-200">
                &larr; Back to Payment
              </button>
              <button type="submit" id="confirmOrderBtn" class="bg-green-600 text-white font-bold py-4 px-10 rounded-xl hover:bg-green-700 transition duration-200 shadow-xl shadow-green-500/50">
                Confirm & Place Order
              </button>
            </div>
          </section>

          <!-- Loading/Submission State -->
          <div id="loading-state" class="step-section card-container p-10 bg-white rounded-2xl border border-gray-300 text-center hidden">
            <div class="flex justify-center mb-4">
              <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-cyan-600"></div>
            </div>
            <h2 class="text-3xl font-bold text-gray-700">Processing Your Order...</h2>
            <p class="text-gray-500 mt-2">Please wait while we finalize the submission. Do not close this window.</p>
          </div>
        </form>

        <!-- Thank You Section -->
        <section id="thankyou-section" class="thankyou-card card-container p-6 md:p-12 bg-white rounded-2xl border-4 border-green-300 hidden text-center mx-auto max-w-lg">
          <div class="text-6xl text-green-500 mb-4">ðŸŽ‰</div>
          <h2 class="text-4xl font-extrabold text-green-700 mb-4">Order Placed Successfully!</h2>
          <p class="mb-6 text-lg text-gray-700">Your purchase has been recorded. You will receive a confirmation email shortly.</p>
          <div class="bg-green-50 p-6 rounded-xl border border-green-200 text-left">
            <p class="text-base"><strong>Order Number:</strong> <span id="thankOrderNumber" class="font-mono text-lg text-gray-800"></span></p>
            <p class="text-base"><strong>Book:</strong> Mind Your Minors - Block 6</p>
            <p class="text-base"><strong>Total Paid:</strong> <span id="thankTotalAmount" class="text-green-600 font-bold text-xl"></span></p>
            <p class="text-base"><strong>Coupon Used:</strong> <span id="thankCouponUsed"></span></p>
          </div>
          <p class="text-sm text-gray-500 mt-4">For any issues, please reference your Order Number.</p>
        </section>

      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const StepController = {
    steps: [
      { id: "shipping-step", name: "Details & Discount", fields: ["firstName", "lastName", "contactNumber", "collegeSelect", "streetAddress", "city", "province", "zipCode"] },
      { id: "payment-step", name: "Payment & Receipt", fields: ["paymentSlip"] },
      { id: "review-step", name: "Confirm Order", fields: [] }
    ],
    currentStepIndex: 0,
    basePrice: 500.00,
    totalAmount: 500.00,
    coupon: { code: "None", discount: 0.00, used: false },

    init: function() {
      this.cacheDom();
      this.bindEvents();
      this.renderProgressSteps();
      this.updateStepUI();
      this.updateSummary();
    },

    cacheDom: function() {
      this.form = document.getElementById("checkout-form");
      this.stepSections = document.querySelectorAll(".step-section");
      this.stepContainer = document.getElementById("step-container");
      this.aimcFields = document.getElementById("aimc-fields");
      this.collegeSelect = document.getElementById("collegeSelect");
      this.couponInput = document.getElementById("couponCode");
      this.couponStatus = document.getElementById("couponStatus");
      this.summaryTotalEl = document.getElementById("summaryTotal");
      this.summaryDiscountEl = document.getElementById("summaryDiscount");
      this.summaryCouponDisplayEl = document.getElementById("summaryCouponDisplay");
      this.amountPaidDisplayEl = document.getElementById("amountPaidDisplay");
      this.reviewTotalEl = document.getElementById("reviewTotal");
      this.reviewCouponEl = document.getElementById("reviewCoupon");
      this.reviewShippingDetailsEl = document.getElementById("reviewShippingDetails");
      this.reviewContactEl = document.getElementById("reviewContact");
      this.mobileStepNumEl = document.getElementById("mobile-step-num");
      this.mobileStepNameEl = document.getElementById("mobile-step-name");
      this.mobileProgressFillEl = document.getElementById("mobile-progress-fill");
      this.thankYouSection = document.getElementById("thankyou-section");
      this.loadingState = document.getElementById("loading-state");
      this.submitMessage = document.getElementById("submit-message");
    },

    bindEvents: function() {
      this.collegeSelect.addEventListener("input", this.handleCollegeSelect.bind(this));
      document.getElementById("applyCouponBtn").addEventListener("click", this.applyCoupon.bind(this));
      this.form.addEventListener("submit", this.handleSubmit.bind(this));
      document.querySelectorAll('[data-step-action="next"]').forEach(btn => {
        btn.addEventListener("click", () => this.validateAndGoToStep(this.currentStepIndex + 1));
      });
      document.querySelectorAll('[data-step-action="prev"]').forEach(btn => {
        btn.addEventListener("click", () => this.goToStep(this.currentStepIndex - 1));
      });
      this.stepContainer.addEventListener('click', (e) => {
        if (e.target.closest('.progress-step')) {
          const targetIndex = parseInt(e.target.closest('.progress-step').dataset.stepIndex);
          if (targetIndex < this.currentStepIndex) {
            this.goToStep(targetIndex);
          } else if (targetIndex === this.currentStepIndex + 1) {
             // Only allow clicking next step if current step is valid
            this.validateAndGoToStep(targetIndex);
          } else {
            // Prevent skipping steps
            this.showError("Please complete the current step before proceeding.");
          }
        }
      });
    },
    
    // --- Core Logic Functions ---

    handleCollegeSelect: function() {
      const isAIMC = this.collegeSelect.value.toLowerCase().includes("allama iqbal medical college");
      this.aimcFields.classList.toggle("hidden", !isAIMC);
      
      // Reset coupon if AIMC is deselected
      if (!isAIMC && this.coupon.used) {
        this.resetCoupon();
        this.updateSummary();
      }
    },

    applyCoupon: function() {
      const val = this.couponInput.value.trim().toUpperCase();
      this.resetCoupon(); // Always reset before applying

      if (val === "AIMC20" && this.collegeSelect.value.toLowerCase().includes("allama iqbal medical college")) {
        this.coupon.code = val;
        this.coupon.discount = 100.00; // 500 - 100 = 400
        this.coupon.used = true;
        this.couponStatus.innerHTML = '<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>';
        this.couponStatus.title = "Coupon Applied!";
      } else if (val === "AIMC20" && !this.collegeSelect.value.toLowerCase().includes("allama iqbal medical college")) {
        this.couponStatus.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>';
        this.couponStatus.title = "Coupon is only for AIMC students.";
        this.showError("This coupon is restricted to AIMC students.");
      } else if (val) {
        this.couponStatus.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>';
        this.couponStatus.title = "Invalid Coupon.";
        this.showError("Invalid coupon code.");
      } else {
        this.couponStatus.innerHTML = '';
        this.couponStatus.title = "";
      }
      this.updateSummary();
    },

    resetCoupon: function() {
      this.coupon = { code: "None", discount: 0.00, used: false };
      this.totalAmount = this.basePrice;
    },

    updateSummary: function() {
      this.totalAmount = this.basePrice - this.coupon.discount;
      const totalFormatted = `â‚¨${this.totalAmount.toFixed(2)}`;
      const discountFormatted = `-â‚¨${this.coupon.discount.toFixed(2)}`;

      // Update Order Summary Card
      this.summaryTotalEl.textContent = totalFormatted;
      this.summaryDiscountEl.textContent = discountFormatted;
      this.summaryDiscountEl.classList.toggle("text-red-500", this.coupon.used);
      this.summaryCouponDisplayEl.textContent = this.coupon.used ? this.coupon.code : 'None';

      // Update Step 2 (Payment)
      this.amountPaidDisplayEl.textContent = totalFormatted;

      // Update Step 3 (Review)
      this.reviewTotalEl.textContent = totalFormatted;
      this.reviewCouponEl.textContent = this.coupon.used ? this.coupon.code : 'None';
      this.reviewCouponEl.classList.toggle("text-red-500", this.coupon.used);
      this.reviewCouponEl.classList.toggle("text-gray-500", !this.coupon.used);
    },

    // --- Navigation & UI Functions ---
    
    validateStep: function(stepIndex) {
      const step = this.steps[stepIndex];
      let isValid = true;
      let firstInvalidField = null;

      step.fields.forEach(fieldId => {
        const input = document.getElementById(fieldId);
        if (input && !input.value.trim()) {
          isValid = false;
          input.classList.add("border-red-500");
          if (!firstInvalidField) firstInvalidField = input;
        } else if (input) {
          input.classList.remove("border-red-500");
        }
      });

      if (isValid && stepIndex === 1) { // Special validation for Step 2: check if file is uploaded
        const paymentSlip = document.getElementById("paymentSlip");
        if (!paymentSlip.files.length) {
          isValid = false;
          paymentSlip.classList.add("border-red-500");
          this.showError("Please upload the payment slip to proceed.");
        } else {
          paymentSlip.classList.remove("border-red-500");
        }
      }
      
      if (!isValid && firstInvalidField) {
        this.showError("Please fill in all required fields.");
        firstInvalidField.focus();
      }
      return isValid;
    },

    validateAndGoToStep: function(nextIndex) {
      if (this.currentStepIndex === 0 && !this.validateStep(0)) {
        return;
      }
      if (this.currentStepIndex === 1 && !this.validateStep(1)) {
        return;
      }
      this.goToStep(nextIndex);
    },

    goToStep: function(index) {
      if (index < 0 || index >= this.steps.length) return;

      // Update Review Step Data before showing it
      if (index === 2) {
        this.updateReviewData();
      }

      this.currentStepIndex = index;
      this.updateStepUI();
    },

    updateStepUI: function() {
      // 1. Update Step Visibility
      this.stepSections.forEach((section, i) => {
        section.classList.remove("step-active");
        section.classList.add("hidden");
        if (i === this.currentStepIndex) {
          section.classList.remove("hidden");
          setTimeout(() => section.classList.add("step-active"), 50); // Small delay for transition
        }
      });

      // 2. Update Progress Bar
      const stepsElements = document.querySelectorAll(".progress-step");
      stepsElements.forEach((el, i) => {
        const circle = el.querySelector(".step-circle");
        const title = el.querySelector(".step-title");

        circle.classList.remove("step-circle-active", "step-circle-inactive", "step-circle-complete");
        title.classList.remove("font-extrabold", "text-cyan-700", "text-gray-900");

        if (i < this.currentStepIndex) {
          circle.innerHTML = '&#10003;'; // Checkmark
          circle.classList.add("step-circle-complete");
          title.classList.add("text-gray-600");
        } else if (i === this.currentStepIndex) {
          circle.innerHTML = i + 1;
          circle.classList.add("step-circle-active");
          title.classList.add("font-extrabold", "text-cyan-700");
        } else {
          circle.innerHTML = i + 1;
          circle.classList.add("step-circle-inactive");
          title.classList.add("text-gray-900");
        }
      });

      // 3. Update Mobile Progress
      const progress = ((this.currentStepIndex + 1) / this.steps.length) * 100;
      this.mobileProgressFillEl.style.width = `${progress}%`;
      this.mobileStepNumEl.textContent = this.currentStepIndex + 1;
      this.mobileStepNameEl.textContent = this.steps[this.currentStepIndex].name;
    },

    renderProgressSteps: function() {
      this.stepContainer.innerHTML = this.steps.map((step, i) => `
        <div data-step-index="${i}" class="progress-step">
          <div class="step-circle step-circle-inactive">${i + 1}</div>
          <div>
            <h3 class="step-title font-semibold text-gray-900">${step.name}</h3>
            <p class="text-sm text-gray-500">${i < this.currentStepIndex ? 'Completed' : 'Pending'}</p>
          </div>
        </div>
      `).join('');
    },

    updateReviewData: function() {
      // Collect all shipping data for the final review
      const firstName = document.getElementById("firstName").value;
      const lastName = document.getElementById("lastName").value;
      const college = document.getElementById("collegeSelect").value;
      const rollNumber = document.getElementById("rollNumber").value;
      const contactNumber = document.getElementById("contactNumber").value;
      const street = document.getElementById("streetAddress").value;
      const city = document.getElementById("city").value;
      const province = document.getElementById("province").value;
      const zipCode = document.getElementById("zipCode").value;

      let address = `${firstName} ${lastName}\n`;
      address += `${street}, ${city}, ${province} ${zipCode}\n`;
      address += `College: ${college}`;
      if (this.collegeSelect.value.toLowerCase().includes("allama iqbal medical college") && rollNumber) {
        address += ` (Roll No: ${rollNumber})`;
      }

      this.reviewShippingDetailsEl.textContent = address;
      this.reviewContactEl.textContent = contactNumber;
    },

    showError: function(message) {
      this.submitMessage.textContent = message;
      this.submitMessage.classList.remove("hidden");
      setTimeout(() => this.submitMessage.classList.add("hidden"), 3000);
    },

    // --- Submission ---

    handleSubmit: async function(e) {
      e.preventDefault();

      if (!this.validateStep(1) || !this.validateStep(2)) {
         // Final check: Step 1 fields are already checked before moving to 2.
         // Step 2 is checked before moving to 3. Only need to re-check Step 2 file upload.
        this.showError("Please check all steps and ensure the payment slip is uploaded.");
        return;
      }
      
      // Hide review step, show loading state
      document.getElementById("review-step").classList.remove("step-active");
      document.getElementById("review-step").classList.add("hidden");
      this.loadingState.classList.remove("hidden");
      this.loadingState.classList.add("step-active");
      
      const formData = new FormData(this.form);

      // 1. Generate unique order number and update hidden fields
      const orderNumber = "MYM-" + Date.now();
      const totalAmount = this.totalAmount.toFixed(2);
      
      formData.set("Order Number", orderNumber);
      formData.set("Total Amount Paid", `â‚¨${totalAmount}`);
      formData.set("Coupon Used", this.coupon.code);
      formData.set("_subject", "New MYM Order #" + orderNumber);

      try {
        const response = await fetch("https://formsubmit.co/ajax/hasnainmughal4200@gmail.com", {
          method: "POST",
          body: formData
        });
        const result = await response.json();

        // 2. Handle Success/Failure
        this.loadingState.classList.remove("step-active");
        this.loadingState.classList.add("hidden");

        if (result.success) {
          this.form.style.display = "none";
          this.thankYouSection.classList.remove("hidden");
          setTimeout(() => this.thankYouSection.classList.add("thankyou-active"), 50);

          // Update Thank You Message
          document.getElementById("thankOrderNumber").textContent = orderNumber;
          document.getElementById("thankTotalAmount").textContent = `â‚¨${totalAmount}`;
          document.getElementById("thankCouponUsed").textContent = this.coupon.code;
        } else {
          this.showError("Submission failed. Please check your connection and try again.");
          document.getElementById("review-step").classList.remove("hidden");
          document.getElementById("review-step").classList.add("step-active");
        }
      } catch (err) {
        this.loadingState.classList.remove("step-active");
        this.loadingState.classList.add("hidden");
        this.showError(`Error sending the form: ${err.message}. Please try again.`);
        document.getElementById("review-step").classList.remove("hidden");
        document.getElementById("review-step").classList.add("step-active");
      }
    }
  };

  StepController.init();
});
</script>
</body>
</html>

